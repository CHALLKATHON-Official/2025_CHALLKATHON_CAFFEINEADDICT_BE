name: Deploy to EC2

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/momento-server
  DOCKER_TAG: ${{ github.sha }}

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value={{branch}}-{{date 'YYYYMMDD-HHmmss'}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:latest
            ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}
            ${{ env.DOCKER_IMAGE }}:develop-${{ github.run_number }}
          cache-from: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.DOCKER_IMAGE }}:buildcache,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.run_number }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cat > .env << EOF
          # Docker
          DOCKER_USERNAME=${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD=${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE=${{ env.DOCKER_IMAGE }}
          DOCKER_TAG=${{ env.DOCKER_TAG }}

          # Spring Profile
          SPRING_PROFILES_ACTIVE=dev

          # MySQL
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}

          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}

          # Kakao OAuth
          KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_REDIRECT_URI=https://dev.caffeineoverdose.shop/login/oauth2/code/kakao

          # App Config
          AUTHORIZED_REDIRECT_URIS=https://dev.caffeineoverdose.shop/oauth2/redirect
          ALLOWED_ORIGINS=https://dev.caffeineoverdose.shop
          COOKIE_DOMAIN=.caffeineoverdose.shop
          SWAGGER_ENABLED=true
          EOF

      - name: Create deployment script
        run: |
          cat > deploy.sh << 'SCRIPT'
          #!/bin/bash
          set -e

          echo "ğŸš€ ë°°í¬ ì‹œì‘..."

          # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
          if [ ! -f .env ]; then
            echo "âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

          # .env íŒŒì¼ ë¡œë“œ ë° export
          set -a
          source .env
          set +a

          # í•„ìˆ˜ ë³€ìˆ˜ í™•ì¸
          if [ -z "$DOCKER_IMAGE" ] || [ -z "$DOCKER_TAG" ]; then
            echo "âŒ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
            echo "DOCKER_IMAGE: $DOCKER_IMAGE"
            echo "DOCKER_TAG: $DOCKER_TAG"
            exit 1
          fi

          # ì´ì „ ì´ë¯¸ì§€ íƒœê·¸ ì €ì¥
          PREVIOUS_TAG=$(docker inspect momento-server --format='{{.Config.Image}}' 2>/dev/null || echo "none")
          echo "í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì´ë¯¸ì§€: $PREVIOUS_TAG"

          # Docker Hub ë¡œê·¸ì¸
          echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

          # ìƒˆ ì´ë¯¸ì§€ pull
          echo "ìƒˆ ì´ë¯¸ì§€ pull ì¤‘: ${DOCKER_IMAGE}:${DOCKER_TAG}"
          docker pull ${DOCKER_IMAGE}:${DOCKER_TAG}
          docker pull ${DOCKER_IMAGE}:latest

          # ìƒˆ ì»¨í…Œì´ë„ˆë¡œ êµì²´ (Blue-Green ë°°í¬)
          echo "Blue-Green ë°°í¬ ì‹œì‘..."

          # ì„ì‹œ ë„¤íŠ¸ì›Œí¬ í™•ì¸/ìƒì„±
          docker network ls | grep momento_momento-network || docker network create momento_momento-network

          # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
          docker run -d \
            --name momento-server-new \
            --network momento_momento-network \
            -p 8081:8080 \
            --env-file .env \
            -e SPRING_DATASOURCE_URL="jdbc:mysql://mysql:3306/${MYSQL_DATABASE}?serverTimezone=Asia/Seoul&characterEncoding=UTF-8" \
            -e SPRING_DATASOURCE_USERNAME="${MYSQL_USER}" \
            -e SPRING_DATASOURCE_PASSWORD="${MYSQL_PASSWORD}" \
            -v momento_app_logs:/var/log/momento \
            ${DOCKER_IMAGE}:${DOCKER_TAG}

          # ìƒˆ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬
          echo "ìƒˆ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ì¤‘..."
          max_attempts=30
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            if docker exec momento-server-new wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health 2>/dev/null; then
              echo "âœ… ìƒˆ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              break
            else
              echo "í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘... ($attempt/$max_attempts)"
              if [ $attempt -eq $max_attempts ]; then
                echo "âŒ ìƒˆ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                docker logs --tail=50 momento-server-new
                docker rm -f momento-server-new
                exit 1
              fi
              sleep 2
              ((attempt++))
            fi
          done

          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì œê±°
          if docker ps -a | grep -q " momento-server$"; then
            echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ì¤‘..."
            docker stop momento-server || true
            docker rm momento-server || true
          fi

          # ìƒˆ ì»¨í…Œì´ë„ˆë¥¼ 8080 í¬íŠ¸ë¡œ ì¬ì‹œì‘
          docker stop momento-server-new
          docker rm momento-server-new

          # ì •ì‹ ì»¨í…Œì´ë„ˆë¡œ ì‹œì‘
          docker run -d \
            --name momento-server \
            --network momento_momento-network \
            -p 8080:8080 \
            --env-file .env \
            -e SPRING_DATASOURCE_URL="jdbc:mysql://mysql:3306/${MYSQL_DATABASE}?serverTimezone=Asia/Seoul&characterEncoding=UTF-8" \
            -e SPRING_DATASOURCE_USERNAME="${MYSQL_USER}" \
            -e SPRING_DATASOURCE_PASSWORD="${MYSQL_PASSWORD}" \
            -v momento_app_logs:/var/log/momento \
            --restart unless-stopped \
            ${DOCKER_IMAGE}:${DOCKER_TAG}

          # nginx ì¬ì‹œì‘
          docker restart momento-nginx || echo "Nginx ì¬ì‹œì‘ ì‹¤íŒ¨ (ë¬´ì‹œ)"

          # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
          if [ "$PREVIOUS_TAG" != "none" ] && [ "$PREVIOUS_TAG" != "${DOCKER_IMAGE}:${DOCKER_TAG}" ]; then
            echo "ì´ì „ ì´ë¯¸ì§€ ì œê±°: $PREVIOUS_TAG"
            docker rmi $PREVIOUS_TAG || true
          fi

          # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
          docker image prune -f

          echo "âœ… ë°°í¬ ì™„ë£Œ!"
          docker ps | grep momento
          SCRIPT

          chmod +x deploy.sh


      - name: Create docker-compose override
        run: |
          cat > docker-compose.override.yml << EOF
          services:
            momento-server:
              image: ${DOCKER_IMAGE}:${DOCKER_TAG}
          EOF

      - name: Create deployment package
        run: |
          tar -czf deploy.tar.gz \
            docker-compose.yml \
            docker-compose.override.yml \
            nginx/ \
            mysql/ \
            .env \
            deploy.sh

      - name: Transfer files to EC2
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "deploy.tar.gz"
          target: "/home/${{ secrets.EC2_USER }}/momento"
          overwrite: true

      - name: Execute deployment
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 10m
          script: |
            cd /home/${{ secrets.EC2_USER }}/momento
            
            # ë°±ì—…
            [ -f .env ] && cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
            
            # ì••ì¶• í•´ì œ
            tar -xzf deploy.tar.gz
            rm deploy.tar.gz
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            ./deploy.sh
            
            # ìµœì¢… í™•ì¸
            sleep 5
            curl -f https://dev.caffeineoverdose.shop/actuator/health || exit 1
            
            echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ì´ë¯¸ì§€: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}"
            echo "URL: https://dev.caffeineoverdose.shop"

      - name: Cleanup on failure
        if: failure()
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/${{ secrets.EC2_USER }}/momento
            
            # ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            docker rm -f momento-server-new 2>/dev/null || true
            
            # ì´ì „ ë°±ì—…ì—ì„œ ë³µêµ¬
            if [ -f .env.backup.* ]; then
              latest_backup=$(ls -t .env.backup.* | head -1)
              cp $latest_backup .env
              docker compose up -d momento-server
            fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
            echo "- ì´ë¯¸ì§€: ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}"
            echo "- URL: https://dev.caffeineoverdose.shop"
            echo "- ë¹Œë“œ ë²ˆí˜¸: ${{ github.run_number }}"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
          fi