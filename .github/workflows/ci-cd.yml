name: Docker CI/CD Pipeline

on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: momento-server

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build and Push Docker Image
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.meta.outputs.digest }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            # ë¸Œëœì¹˜ ì´ë¦„ íƒœê·¸ (main, develop ë“±)
            type=ref,event=branch

            # PR íƒœê·¸ (pr-5 í˜•ì‹)
            type=ref,event=pr

            # ë¸Œëœì¹˜-SHA íƒœê·¸ (main ë¸Œëœì¹˜ì¼ ë•Œë§Œ)
            type=raw,value=main-{{sha}},enable=${{ github.ref == 'refs/heads/main' }}

            # develop-SHA íƒœê·¸ (develop ë¸Œëœì¹˜ì¼ ë•Œë§Œ)
            type=raw,value=develop-{{sha}},enable=${{ github.ref == 'refs/heads/develop' }}

            # PR-SHA íƒœê·¸ (PRì¼ ë•Œë§Œ)
            type=raw,value=pr-${{github.event.number}}-{{sha}},enable=${{ github.event_name == 'pull_request' }}

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v6.10.0
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-production:
    runs-on: ubuntu-latest
    needs: build-and-push
    name: ğŸš€ Deploy to Development
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: development
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > deploy_key.pem
          chmod 600 deploy_key.pem

      - name: ğŸ·ï¸ Get image tag  
        id: image
        run: |
          # metadata ì•¡ì…˜ì—ì„œ ìƒì„±ëœ íƒœê·¸ ì¤‘ ì²« ë²ˆì§¸ ì‚¬ìš©
          IMAGE_TAG=$(echo "${{ needs.build-and-push.outputs.image-tag }}" | head -n1)
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Using image tag: ${IMAGE_TAG}"

      - name: ğŸ“ Create deployment script with direct substitution
        run: |
          # ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ë¥¼ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± ì‹œì ì— ì§ì ‘ ì¹˜í™˜
          IMAGE_TAG="${{ steps.image.outputs.tag }}"
          DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
          SSL_EMAIL="${{ secrets.SSL_EMAIL }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}"
          KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}"
          KAKAO_REDIRECT_URI="${{ secrets.KAKAO_REDIRECT_URI }}"
          AUTHORIZED_REDIRECT_URIS="${{ secrets.AUTHORIZED_REDIRECT_URIS }}"
          ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"
          COOKIE_DOMAIN="${{ secrets.COOKIE_DOMAIN }}"
          SWAGGER_ENABLED="${{ secrets.SWAGGER_ENABLED }}"
          MYSQL_ROOT_PASSWORD="${{ secrets.MYSQL_ROOT_PASSWORD }}"
          MYSQL_DATABASE="${{ secrets.MYSQL_DATABASE }}"
          MYSQL_USER="${{ secrets.MYSQL_USER }}"
          MYSQL_PASSWORD="${{ secrets.MYSQL_PASSWORD }}"
          
          # í™˜ê²½ ë³€ìˆ˜ ê²€ì¦
          echo "ğŸ” Validating environment variables..."
          echo "IMAGE_TAG: ${IMAGE_TAG}"
          echo "DOMAIN_NAME: ${DOMAIN_NAME}"
          echo "MYSQL_DATABASE: ${MYSQL_DATABASE}"
          
          # Docker Compose íŒŒì¼ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¯¸ë¦¬ ì¹˜í™˜í•˜ì—¬ ìƒì„±
          cat > docker-compose.deploy.yml << 'COMPOSE_EOF'
          services:
            momento-server:
              image: ${IMAGE_TAG}
              container_name: momento-server
              restart: unless-stopped
              ports:
                - "8080:8080"
              environment:
                SPRING_PROFILES_ACTIVE: dev
                JWT_SECRET: "${JWT_SECRET}"
                KAKAO_CLIENT_ID: "${KAKAO_CLIENT_ID}"
                KAKAO_CLIENT_SECRET: "${KAKAO_CLIENT_SECRET}"
                KAKAO_REDIRECT_URI: "${KAKAO_REDIRECT_URI}"
                AUTHORIZED_REDIRECT_URIS: "${AUTHORIZED_REDIRECT_URIS}"
                ALLOWED_ORIGINS: "${ALLOWED_ORIGINS}"
                COOKIE_DOMAIN: "${COOKIE_DOMAIN}"
                SWAGGER_ENABLED: "${SWAGGER_ENABLED}"
              depends_on:
                mysql:
                  condition: service_healthy
              networks:
                - momento-network
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
                interval: 30s
                timeout: 10s
                retries: 3
                start_period: 40s

            mysql:
              image: mysql:8.0
              container_name: momento-mysql
              restart: unless-stopped
              environment:
                MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
                MYSQL_DATABASE: "${MYSQL_DATABASE}"
                MYSQL_USER: "${MYSQL_USER}"
                MYSQL_PASSWORD: "${MYSQL_PASSWORD}"
                MYSQL_ROOT_HOST: '%'
              ports:
                - "3306:3306"
              volumes:
                - mysql-data:/var/lib/mysql
                - ./docker/mysql/conf.d:/etc/mysql/conf.d
              networks:
                - momento-network
              healthcheck:
                test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
                interval: 10s
                timeout: 5s
                retries: 5
                start_period: 30s

            nginx:
              image: nginx:alpine
              container_name: momento-nginx
              restart: unless-stopped
              ports:
                - "80:80"
                - "443:443"
              volumes:
                - ./docker/nginx/conf.d:/etc/nginx/conf.d
                - ./docker/nginx/ssl:/etc/nginx/ssl
                - certbot-data:/var/www/certbot
                - certbot-conf:/etc/letsencrypt
              depends_on:
                - momento-server
              networks:
                - momento-network

            certbot:
              image: certbot/certbot
              container_name: momento-certbot
              volumes:
                - certbot-data:/var/www/certbot
                - certbot-conf:/etc/letsencrypt
              command: certonly --webroot --webroot-path=/var/www/certbot --email ${SSL_EMAIL} --agree-tos --no-eff-email -d ${DOMAIN_NAME}

          volumes:
            mysql-data:
              driver: local
            certbot-data:
              driver: local
            certbot-conf:
              driver: local

          networks:
            momento-network:
              driver: bridge
          COMPOSE_EOF
          
          # í™˜ê²½ ë³€ìˆ˜ ì¹˜í™˜
          envsubst < docker-compose.deploy.yml > docker-compose.final.yml
          
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (ëª¨ë“  ë³€ìˆ˜ê°€ ì´ë¯¸ ì¹˜í™˜ë¨)
          cat > deploy.sh << 'DEPLOY_EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ Starting deployment process..."
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì •ë¦¬
          echo "ğŸ›‘ Stopping existing containers..."
          if command -v docker-compose &> /dev/null; then
            docker-compose down || true
          elif docker compose version &> /dev/null; then
            docker compose down || true
          else
            echo "âŒ Docker Compose not found!"
            exit 1
          fi
          
          # ë„ë©”ì¸ ì„¤ì • ì ìš©
          echo "ğŸŒ Configuring domain settings..."
          if [ -f docker/nginx/conf.d/momento.conf ] && [ ! -z "${DOMAIN_NAME}" ]; then
            sed "s/\${DOMAIN_NAME}/${DOMAIN_NAME}/g" docker/nginx/conf.d/momento.conf > docker/nginx/conf.d/momento_final.conf
            mv docker/nginx/conf.d/momento_final.conf docker/nginx/conf.d/momento.conf
          fi
          
          # ìµœì¢… Docker Compose íŒŒì¼ ì‚¬ìš©
          echo "ğŸ“‹ Using pre-configured docker-compose.final.yml..."
          cp docker-compose.final.yml docker-compose.yml
          
          echo "ğŸ“‹ Final docker-compose.yml content:"
          cat docker-compose.yml
          
          # ìƒˆ ì´ë¯¸ì§€ í’€ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸ“¥ Pulling new image and starting containers..."
          
          # Docker Compose ëª…ë ¹ì–´ ê²°ì •
          COMPOSE_CMD=""
          if command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
          elif docker compose version &> /dev/null; then
            COMPOSE_CMD="docker compose"
          else
            echo "âŒ No Docker Compose command available!"
            exit 1
          fi
          
          echo "Using Docker Compose command: ${COMPOSE_CMD}"
          
          # ì´ë¯¸ì§€ í’€ ì‹œë„
          if ! ${COMPOSE_CMD} pull momento-server; then
            echo "âŒ Failed to pull momento-server image"
            echo "Available images:"
            docker images | grep momento-server || echo "No momento-server images found"
            exit 1
          fi
          
          # ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸš€ Starting containers..."
          ${COMPOSE_CMD} up -d
          
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“Š Container status:"
          ${COMPOSE_CMD} ps
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ Performing health check..."
          for i in {1..30}; do
            if ${COMPOSE_CMD} exec -T momento-server curl -f http://localhost:8080/actuator/health 2>/dev/null; then
              echo "âœ… Health check passed!"
              break
            fi
            echo "â³ Waiting for application to start... ($i/30)"
            sleep 10
          done
          
          echo "ğŸ‰ Deployment completed successfully!"
          DEPLOY_EOF
          
          # í™˜ê²½ ë³€ìˆ˜ ê°’ë“¤ì„ ìŠ¤í¬ë¦½íŠ¸ì— ì§ì ‘ ì¹˜í™˜
          sed -i "s/\${DOMAIN_NAME}/${DOMAIN_NAME}/g" deploy.sh
          sed -i "s/\${SSL_EMAIL}/${SSL_EMAIL}/g" deploy.sh

      - name: ğŸ“ Prepare deployment directory
        run: |
          ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /opt/momento
            sudo chown ubuntu:ubuntu /opt/momento
            
            # PATH í™˜ê²½ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
            export PATH="/usr/local/bin:$PATH"
            echo 'export PATH="/usr/local/bin:$PATH"' >> ~/.bashrc
            
            # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
            echo "ğŸ” Checking Docker Compose availability..."
            
            # Docker Compose V2 (docker compose) í™•ì¸
            if docker compose version &> /dev/null; then
              echo "âœ… Docker Compose V2 (docker compose) is available"
            # Docker Compose V1 (docker-compose) í™•ì¸
            elif command -v docker-compose &> /dev/null; then
              echo "âœ… Docker Compose V1 (docker-compose) is available"
            else
              echo "ğŸ³ Installing Docker Compose..."
              # ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ
              COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
              sudo curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              
              # ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± (PATH ë³´ì¥)
              sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
              
              # ì„¤ì¹˜ í™•ì¸
              if /usr/local/bin/docker-compose --version; then
                echo "âœ… Docker Compose installation completed: $(/usr/local/bin/docker-compose --version)"
              else
                echo "âŒ Docker Compose installation failed"
                exit 1
              fi
            fi
            
            # í™˜ê²½ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up old deployment files..."
            cd /opt/momento
            rm -f docker-compose.yml docker-compose.final.yml deploy.sh
          EOF

      - name: ğŸ“ Deploy files to EC2
        run: |
          # Docker Compose ë° ì„¤ì • íŒŒì¼ë“¤ì„ EC2ì— ì§ì ‘ ì „ì†¡
          scp -i deploy_key.pem -o StrictHostKeyChecking=no -r \
            docker-compose.yml docker-compose.final.yml docker/ deploy.sh \
            ubuntu@${{ secrets.EC2_HOST }}:/opt/momento/

      - name: ğŸš€ Execute deployment on EC2
        run: |
          # EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ìƒì„¸ ë””ë²„ê¹… í¬í•¨)
          ssh -i deploy_key.pem -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.EC2_HOST }} << 'DEPLOY_CMD'
            cd /opt/momento
            
            echo "ğŸ“‹ Pre-deployment verification..."
            echo "Current directory: $(pwd)"
            echo "Files in directory:"
            ls -la
            
            echo "ğŸ” Checking deploy.sh content preview:"
            head -20 deploy.sh
            
            echo "ğŸ” Checking docker-compose.final.yml content preview:"
            head -20 docker-compose.final.yml
            
            echo "ğŸ³ Docker and Docker Compose status:"
            docker --version
            if command -v docker-compose &> /dev/null; then
              echo "docker-compose: $(docker-compose --version)"
            fi
            if docker compose version &> /dev/null; then
              echo "docker compose: $(docker compose version)"
            fi
            
            echo "ğŸ“‚ Setting execute permissions and running deployment..."
            chmod +x deploy.sh
            
            echo "ğŸš€ Starting deployment execution..."
            ./deploy.sh
          DEPLOY_CMD

      - name: ğŸ§¹ Cleanup SSH key
        run: |
          rm -f deploy_key.pem

      - name: ğŸ“‹ Deployment Summary
        run: |
          echo "ğŸ‰ **Production Deployment Successful!**"
          echo ""
          echo "ğŸ“Š **Deployment Details:**"
          echo "- ğŸŒ Application URL: https://${{ secrets.DOMAIN_NAME }}"
          echo "- ğŸ³ Docker Image: ${{ steps.image.outputs.tag }}"
          echo "- â° Deployed at: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "- ğŸ”€ Branch: ${{ github.ref_name }}"
          echo "- ğŸ“ Commit: ${{ github.sha }}"

