name: Docker CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: momento-server

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    name: ğŸ—ï¸ Build and Push Docker Image
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v6.10.0
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-production:
    runs-on: ubuntu-latest
    needs: build-and-push
    name: ğŸš€ Deploy to Production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”‘ Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > deploy_key.pem
          chmod 600 deploy_key.pem

      - name: ğŸ·ï¸ Get image tag
        id: image
        run: |
          IMAGE_TAG=${{ env.DOCKER_REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:main-${{ github.sha }}
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: ğŸ“ Create deployment script
        run: |
          cat > deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          export IMAGE_TAG="${{ steps.image.outputs.tag }}"
          export DOMAIN_NAME="${{ secrets.DOMAIN_NAME }}"
          export SSL_EMAIL="${{ secrets.SSL_EMAIL }}"
          
          # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì •ë¦¬
          echo "ğŸ›‘ Stopping existing containers..."
          docker-compose down || true
          
          # ìƒˆ ì´ë¯¸ì§€ë¡œ docker-compose ì—…ë°ì´íŠ¸ ë° í™˜ê²½ë³€ìˆ˜ ì£¼ì…
          echo "ğŸ“ Updating docker-compose.yml with new image..."
          sed -i "s|build:|#build:|g" docker-compose.yml
          sed -i "s|context: .|#context: .|g" docker-compose.yml
          sed -i "s|dockerfile: Dockerfile|#dockerfile: Dockerfile|g" docker-compose.yml
          sed -i "/momento-server:/a\\    image: ${IMAGE_TAG}" docker-compose.yml
          
          # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          echo "ğŸ”§ Setting up environment variables..."
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          export KAKAO_CLIENT_ID="${{ secrets.KAKAO_CLIENT_ID }}"
          export KAKAO_CLIENT_SECRET="${{ secrets.KAKAO_CLIENT_SECRET }}"
          export KAKAO_REDIRECT_URI="${{ secrets.KAKAO_REDIRECT_URI }}"
          export AUTHORIZED_REDIRECT_URIS="${{ secrets.AUTHORIZED_REDIRECT_URIS }}"
          export ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"
          export COOKIE_DOMAIN="${{ secrets.COOKIE_DOMAIN }}"
          export SWAGGER_ENABLED="${{ secrets.SWAGGER_ENABLED }}"
          export MYSQL_ROOT_PASSWORD="${{ secrets.MYSQL_ROOT_PASSWORD }}"
          export MYSQL_DATABASE="${{ secrets.MYSQL_DATABASE }}"
          export MYSQL_USER="${{ secrets.MYSQL_USER }}"
          export MYSQL_PASSWORD="${{ secrets.MYSQL_PASSWORD }}"
          
          # ë„ë©”ì¸ ì„¤ì • ì ìš©
          echo "ğŸŒ Configuring domain settings..."
          envsubst '${DOMAIN_NAME}' < docker/nginx/conf.d/momento.conf > docker/nginx/conf.d/momento_final.conf
          mv docker/nginx/conf.d/momento_final.conf docker/nginx/conf.d/momento.conf
          
          # Docker Compose í™˜ê²½ ë³€ìˆ˜ë¡œ ì‹¤í–‰ (sed ëŒ€ì‹  í™˜ê²½ ë³€ìˆ˜ í™œìš©)
          echo "ğŸ”§ Docker Compose will use environment variables directly"
          
          # ìƒˆ ì´ë¯¸ì§€ í’€ ë° ì»¨í…Œì´ë„ˆ ì‹œì‘
          echo "ğŸ“¥ Pulling new image and starting containers..."
          docker-compose pull momento-server
          docker-compose up -d
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ¥ Performing health check..."
          for i in {1..30}; do
            if docker-compose exec -T momento-server curl -f http://localhost:8080/actuator/health; then
              echo "âœ… Health check passed!"
              break
            fi
            echo "â³ Waiting for application to start... ($i/30)"
            sleep 10
          done
          
          echo "ğŸ‰ Deployment completed successfully!"
          EOF

      - name: ğŸ³ Install Docker on EC2 (if needed)
        run: |
          ssh -i deploy_key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            # Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              sudo mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
              sudo usermod -aG docker ubuntu
              sudo systemctl enable docker
              sudo systemctl start docker
              echo "âœ… Docker installation completed"
            else
              echo "âœ… Docker is already installed"
            fi
            
            # Docker Compose ì„¤ì¹˜ í™•ì¸
            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ³ Installing Docker Compose..."
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
              echo "âœ… Docker Compose installation completed"
            else
              echo "âœ… Docker Compose is already installed"
            fi
            
            # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
            sudo mkdir -p /opt/momento
            sudo chown ubuntu:ubuntu /opt/momento
          EOF

      - name: ğŸ“ Deploy files to EC2
        run: |
          # Docker Compose ë° ì„¤ì • íŒŒì¼ë“¤ì„ EC2ì— ì§ì ‘ ì „ì†¡
          scp -i deploy_key.pem -o StrictHostKeyChecking=no -r \
            docker-compose.yml docker/ deploy.sh \
            ubuntu@${{ secrets.EC2_HOST }}:/opt/momento/

      - name: ğŸš€ Execute deployment on EC2
        run: |
          # EC2ì—ì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          ssh -i deploy_key.pem -o StrictHostKeyChecking=no \
            ubuntu@${{ secrets.EC2_HOST }} \
            "cd /opt/momento && chmod +x deploy.sh && ./deploy.sh"

      - name: ğŸ§¹ Cleanup SSH key
        run: |
          rm -f deploy_key.pem

      - name: ğŸ“‹ Deployment Summary
        run: |
          echo "ğŸ‰ **Production Deployment Successful!**"
          echo ""
          echo "ğŸ“Š **Deployment Details:**"
          echo "- ğŸŒ Application URL: https://${{ secrets.DOMAIN_NAME }}"
          echo "- ğŸ³ Docker Image: ${{ steps.image.outputs.tag }}"
          echo "- â° Deployed at: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "- ğŸ”€ Branch: ${{ github.ref_name }}"
          echo "- ğŸ“ Commit: ${{ github.sha }}"

