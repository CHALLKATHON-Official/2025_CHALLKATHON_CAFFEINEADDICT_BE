files:
    "/sbin/appstart":
        mode: "000755"
        owner: webapp
        group: webapp
        content: |
            #!/usr/bin/env bash
            JAR_PATH=/var/app/current/application.jar

            # Kill existing Java processes
            killalljava() {
                echo "Stopping existing Java processes..."
                pkill -f "java.*application.jar" || true
                sleep 2
            }

            # Health check function
            health_check() {
                echo "Performing health check..."
                for i in {1..30}; do
                    if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                        echo "Application is healthy"
                        return 0
                    fi
                    echo "Waiting for application to start... ($i/30)"
                    sleep 2
                done
                echo "Health check failed"
                return 1
            }

            # Run app
            killalljava
            echo "Starting application..."
            java -Dspring.profiles.active=dev -Dfile.encoding=UTF-8 -Xms512m -Xmx2048m -XX:+UseG1GC -XX:+UseStringDeduplication -XX:MaxGCPauseMillis=200 -jar $JAR_PATH &
            
            # Wait for app to start and perform health check
            sleep 5
            health_check